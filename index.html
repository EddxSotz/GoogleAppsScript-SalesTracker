<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
  /* RESET & BASE */
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; height: 100vh; overflow: hidden; background-color: #f4f5f7; }

  /* SIDEBAR STYLES */
  #sidebar {
    width: 250px;
    background-color: #2c3e50;
    color: white;
    display: flex;
    flex-direction: column;
    padding-top: 20px;
    flex-shrink: 0;
  }
  #sidebar h2 {
    text-align: center;
    margin-bottom: 30px;
    font-size: 1.2rem;
    color: #ecf0f1;
  }
  .nav-item {
    padding: 15px 20px;
    cursor: pointer;
    border-left: 4px solid transparent;
    transition: all 0.3s;
    color: #bdc3c7;
  }
  .nav-item:hover { background-color: #34495e; color: white; }
  .nav-item.active {
    background-color: #34495e;
    border-left: 4px solid #3498db; /* Blue accent */
    color: white;
  }

  /* MAIN CONTENT AREA */
  #main-content {
    flex: 1;
    overflow-y: auto; /* Scroll only the content, not the sidebar */
    padding: 30px;
  }

  /* VIEW SECTIONS */
  .view-section { display: none; } /* Hidden by default */
  .view-section.active-view { display: block; animation: fadeIn 0.3s; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* FORM & UTILITY STYLES */
  .card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    margin-bottom: 20px;
  }
  h1 { margin-bottom: 1rem; color: #2c3e50; }
  .inline-flex { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; }
  .input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; }
  button {
    padding: 10px 20px;
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  button:disabled { background-color: #bdc3c7; }
  button.secondary { background-color: #95a5a6; }

  /* TABLE STYLES */
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  thead { background-color: #3498db; color: white; }
  th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
  tr:hover { background-color: #f1f1f1; }
  .selected-row { background-color: #2c3e50 !important; color: white; }

  /* LOGS */
  #statusLog { margin-top: 20px; padding: 15px; background: #eef2f3; border-radius: 5px; max-height: 150px; overflow-y: auto; font-family: monospace; }
</style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <nav id="sidebar">
    <h2>ðŸš€ Sales Tracker</h2>
    <div class="nav-item active" onclick="switchTab('view-add-sale')">Add Sale</div>
    <div class="nav-item" onclick="switchTab('view-edit-sale')">Edit Sale</div>
    <div class="nav-item" onclick="switchTab('view-add-product')">Add Product</div>
    <div class="nav-item" onclick="switchTab('view-edit-product')">Edit Product</div>
  </nav>

    <main id="main-content">

    <div id="view-add-sale" class="view-section active-view">
      <h1>New Sale</h1>

      <div class="card">
        <h3>1. Select Store</h3>
        <select id="add-store-select" class="input" style="max-width: 300px;">
          <option value="Sheet1">Store 1</option>
          <option value="Sheet2">Store 2</option>
          <option value="Sheet3">Store 3</option>
          <option value="Sheet4">Store 4</option>
          <option value="Sheet5">Store 5(not on SS)</option>
        </select>
      </div>

      <div class="card">
        <h3>2. Select Product</h3>
        <div id="loading-products">Loading inventory...</div>
        <div style="max-height: 300px; overflow-y: auto;">
          <table id="productTable">
            <thead><tr id="tableHead"></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>3. Sale Details</h3>
        <div class="inline-flex">
          <input id="add-quantity" class="input" type="number" placeholder="Quantity" min="1">
          <select id="add-status" class="input">
            <option value="Completed">Completed</option>
            <option value="Pending">Pending</option>
          </select>
        </div>
        <button id="btnAddSale" onclick="addSheetData()">Submit Sale</button>
      </div>
      <div style="max-width: 600px; margin: 2rem auto;">
      <canvas id="salesChart"></canvas>
    </div>
    </div>

    <div id="view-edit-sale" class="view-section">
      <h1>Edit Existing Sale</h1>

      <div class="card" style="background-color: #e3f2fd;">
        <h3>Find Sale</h3>
        <div class="inline-flex">
          <select id="edit-store-select" class="input">
             <option value="Sheet1">Store 1</option>
              <option value="Sheet2">Store 2</option>
              <option value="Sheet3">Store 3</option>
              <option value="Sheet4">Store 4</option>
              <option value="Sheet5">Store 5(not on SS)</option>
             </select>
          <input id="search-sale-id" class="input" type="text" placeholder="Paste Sale ID...">
          <button onclick="performSearch()">Search</button>
        </div>
      </div>

      <div id="edit-form-container" class="card" style="display:none; border: 2px solid orange;">
        <h3>Update Details</h3>
        <p><strong>Product:</strong> <span id="edit-product-name"></span></p>

        <label>Quantity:</label>
        <input id="edit-quantity" class="input" type="number" style="margin-bottom: 10px;">

        <label>Status:</label>
        <select id="edit-status" class="input" style="margin-bottom: 20px;">
           <option value="Completed">Completed</option>
           <option value="Blocked">Blocked</option>
           <option value="Follow-up">Follow-up</option>
        </select>

        <input type="hidden" id="edit-row-index">

        <button onclick="processUpdateSale()" style="background-color: orange;">Update Sale</button>
        <button class="secondary" onclick="cancelEdit()">Cancel</button>
      </div>
    </div>

    <div id="view-add-product" class="view-section">
      <h1>Add New Product</h1>
      <div class="card">
        <p>ðŸš§ This feature is coming soon.</p>
      </div>
    </div>

    <div id="view-edit-product" class="view-section">
      <h1>Edit Inventory</h1>
      <div class="card">
        <p>ðŸš§ This feature is coming soon.</p>
      </div>
    </div>

    <div id="statusLog">System Ready.</div>
    <footer>Sales Tracker v2.0</footer>
  </main>

    <script>
      let globalSheetNames = [];
      let selectedProductAddMode = null;
      let failedSubmissions = {};
      const statusLog = document.getElementById("statusLog");
      const loadingState = document.getElementById("loading-status");
      const btnAddSale = document.getElementById("btnAddSale");

    window.onload = function() {
      google.script.run
        .withSuccessHandler(initApp)
        .getInitialData();
        fetchStats();
    };

    function initApp(data) {
      renderProductTable(data.headers, data.products);
      globalSheetNames = data.validSheets;
      document.getElementById('loading-products').style.display = 'none';
    }

    function switchTab(viewId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
        document.getElementById(viewId).classList.add('active-view');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
      }

      function renderProductTable(headers, rows) {
      const thead = document.getElementById('tableHead');
      const tbody = document.getElementById('tableBody');

      headers.forEach(h => {
        let th = document.createElement('th');
        th.textContent = h;
        thead.appendChild(th);
      });

      rows.forEach(row => {
        let tr = document.createElement('tr');

        tr.dataset.name = row[1];
        tr.dataset.category = row[2];
        tr.dataset.price = row[3];

        tr.onclick = function() { selectProduct(this); };

        row.forEach(cell => {
          let td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

      function selectProduct(row) {
        document.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row'));
        row.classList.add('selected-row');

        selectedProductAddMode = {
          name: row.dataset.name,
          category: row.dataset.category,
          price: row.dataset.price
        };
      }

      function getSelectedSheetName(view){
        const selectSheetNameContainer = document.getElementById(view);
        const sheetNameSelected = selectSheetNameContainer.options[selectSheetNameContainer.selectedIndex].value;
        const isNameOnSpreadsheet = globalSheetNames.find((sheet) => sheetNameSelected === sheet);
          if(isNameOnSpreadsheet == undefined || isNameOnSpreadsheet == null || sheetNameSelected == ""){
            alert("User name not found on Spreadsheet!")
            selectSheetNameContainer.selectedIndex = -1;
          } else {
            return sheetNameSelected;
          }
      }
      // --- LOGIC: ADD SALE ---
      function addSheetData() {
        const store = getSelectedSheetName('add-store-select');
        const qty = document.getElementById('add-quantity').value;
        const status = getSelectedSaleStatus();

          if (!store || !qty || !selectedProductAddMode) {
          alert("Please select a Store, a Product, and enter Quantity.");
          return;
        }
          const btn = document.getElementById('btnAddSale');
          btn.disabled = true;
          btn.textContent = "Processing...";

          const submissionId = "saleId_" + Date.now();

         const formData = {
          sheet: store,
          name: selectedProductAddMode.name,
          category: selectedProductAddMode.category,
          quantity: qty,
          price: selectedProductAddMode.price,
          status: status,
          saleId: submissionId
        };

          failedSubmissions[submissionId] = formData;
          addLogEntry(submissionId, `Sending ${submissionId} to spreadsheet...`);
          google.script.run.withSuccessHandler(handleSuccess(submissionId)).withFailureHandler(handleError(submissionId)).sendSaleToSheet(formData);
          btn.disabled = false;
      }

      function addLogEntry(submissionId, message) {
        const logEntry = document.createElement("p");
        logEntry.id = submissionId;
        logEntry.innerHTML = message;
        statusLog.prepend(logEntry);
      }

      function handleSuccess(submissionId) {
            return function(){
            const btn = document.getElementById('btnAddSale');
            btn.disabled = false;
            document.getElementById('add-quantity').value = "";
            document.querySelectorAll('.selected-row').forEach(r => r.classList.remove('selected-row'));
            selectedProductAddMode = null;
            const entry = document.getElementById(submissionId);
            entry.style.color = "green";
            entry.innerHTML = `Success: ${submissionId} sent to spreadsheet successfully`;
            delete failedSubmissions[submissionId];
          }
      }

      function handleError(submissionId) {
        return function (error) {
          btn.disabled = false;
          const entry = document.getElementById(submissionId);
          entry.style.color = "red";
          entry.innerHTML = `Unable to send ${submissionId} to Spreadsheet. Please check your internet connection or that you are signed in to your Google account - Error Code: ${error}  <button onclick="retrySubmission('${submissionId}')">Retry</button>`;
        }
      }

      function retrySubmission(submissionId) {
        const formData = failedSubmissions[submissionId];
        const entry = document.getElementById(submissionId);
        entry.style.color = "black";
        entry.innerHTML = `Re-sending ${submissionId} to spreadsheet...`;
        google.script.run.withSuccessHandler(handleSuccess(submissionId)).withFailureHandler(handleError(submissionId)).sendSaleToSheet(formData);
      }

      function getSelectedSaleStatus (){
        const selectSaleStatus = document.getElementById('add-status');
        return selectSaleStatus.options[selectSaleStatus.selectedIndex].value;
      }

      function fetchStats() {
        google.script.run.withSuccessHandler(renderChart).getSalesStats();
      }

    // --- LOGIC: EDIT SALE ---
    function performSearch() {
      const store = getSelectedSheetName('edit-store-select');
      const id = document.getElementById('search-sale-id').value.trim();

      if(!store || !id) { alert("Select store and enter ID"); return; }

      statusLog.textContent = "Searching...";

      google.script.run
        .withSuccessHandler((result) => {
          if(result.found) {
            // Show the Edit Form
            document.getElementById('edit-form-container').style.display = 'block';

            // Populate Fields
            document.getElementById('edit-product-name').textContent = result.product;
            document.getElementById('edit-quantity').value = result.quantity;
            document.getElementById('edit-status').value = result.status;
            document.getElementById('edit-row-index').value = result.row;

            statusLog.textContent = "Sale found.";
          } else {
            alert("Sale ID not found.");
            document.getElementById('edit-form-container').style.display = 'none';
          }
        })
        .findSale(store, id);
    }

    function processUpdateSale() {
      const store = getSelectedSheetName('edit-store-select');
      const rowIndex = document.getElementById('edit-row-index').value;

      const newData = {
        quantity: document.getElementById('edit-quantity').value,
        status: document.getElementById('edit-status').value,
        // We preserve product details as we assume they aren't changing the product itself here
        store: store, // Required by backend logic
        product: document.getElementById('edit-product-name').textContent,
        category: "", // If backend needs it, we might need to fetch/store it during search
      };

      google.script.run
        .withSuccessHandler(() => {
          statusLog.textContent = "Updated";
          cancelEdit();
        })
        .editSale(store, newData, rowIndex);
    }

    function cancelEdit() {
      document.getElementById('edit-form-container').style.display = 'none';
      document.getElementById('search-sale-id').value = "";
    }

// --- LOGIC: Render chart ---
    function renderChart(statsData) {
    const ctx = document.getElementById('salesChart').getContext('2d');

  // 1. Prepare Data for Chart.js
  const labels = statsData.map(item => item.storeName);
  const dataPoints = statsData.map(item => item.count);

  // 2. Chart
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Total Sales per Store',
        data: dataPoints,
        backgroundColor: [
          'rgba(54, 162, 235, 0.6)', // Blue
          'rgba(255, 99, 132, 0.6)', // Red
          'rgba(255, 206, 86, 0.6)', // Yellow
          'rgba(75, 192, 192, 0.6)', // Green
          'rgba(153, 102, 255, 0.6)' // Purple
        ],
        borderColor: [
          'rgba(54, 162, 235, 1)',
          'rgba(255, 99, 132, 1)',
          'rgba(255, 206, 86, 1)',
          'rgba(75, 192, 192, 1)',
          'rgba(153, 102, 255, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
}
      window.addEventListener('beforeunload', function (e) { e.preventDefault(); e.returnValue='';});
    </script>
  </body>
</html>
