<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      body {
        font-family: Arial, Helvetica, sans-serif;
        padding-left: 2rem;
        padding-right: 2rem;
      }
      div {
        margin-top: 1rem;
        margin-bottom: 2rem;
      }
      h1 {
        margin-bottom: 0.5rem;
      }
      p {
        margin-bottom: 1rem;
      }
      button {
        padding: 0.5rem 2rem;
      }
      thead {
        background-color:DodgerBlue;
        color: white;
      }
      th {
        padding: 0.5rem 1rem;
      }
      tbody td {
        padding: 0.25rem 0.5rem;
      }
      tbody > tr:nth-child(2) {
        background-color: #c9c9c9;
      }
      .inline-flex{
         max-width:420px;
         display: flex;
         flex-direction: row;
         align-items: center;
         justify-content: space-between;
         gap: 2rem;
      }
      .input {
        width: 8rem;
        padding: 0.5rem 0rem;
      }
      #saveButton:enabled{
        background-color:DodgerBlue;
        color: white;
        width: 100%;
        max-width: 388px;
      }
      #statusLog {
        height: 8rem;
        margin-bottom: 0;
        padding: 1rem;
        max-width: 420px;
        overflow: auto;
        background-color: #c9c9c9;
      }
    *:disabled {
    background-color: LightGray;
    color: dimgrey;
    opacity: 1;
    }
    footer {
      margin-top: 6rem;
      text-align:center;
    }
    </style>
  </head>
  <body>
    <h1>Sales Tracker</h1>
    <div class="inline-flex">
      <h3>Choose the Store:</h3>
      <select id="sheet-name-container" class="input ">
        <option value=""></option>
        <option value="Sheet1">Store1</option>
        <option value="Sheet2">Store2</option>
        <option value="Sheet3">Store3</option>
        <option value="Sheet4">Store4</option>
        <option value="Sheet5">Store5</option>
      </select>
    </div>

    <form onsubmit="event.preventDefault();" id="form" style="display:block">
      <h1>Log Sale</h1>
      <h3>Product Inventory</h3>
      <div id="loading-status"><span>Loading...</span></div>
      <div class="inline-flex">
        <table id="dataTable">
        <thead>
          <tr id="tableHead"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      </div>

      <div class="inline-flex">
        <h3>Quantity</h3>
        <input id="quantity-container" class="input" type="number" required/>
      </div>
      <div class="inline-flex">
        <h3>Sale Status</h3>
        <select id="status-container" class="input" required>
          <option value=""></option>
          <option value="Completed">Completed</option>
          <option value="Blocked">Blocked</option>
          <option value="Investigation">Follow-up</option>
        </select>
      </div>
      <button id="saveButton">Process</button>
    </form>
    <div id="statusLog"></div>
    <footer>Sales Tracker - 2025</footer>

    <script>
      let failedSubmissions = {};

      /* Save html DOM elements onto constants */
      const form = document.getElementById("form");
      const saveButton = document.getElementById("saveButton");
      const selectSheetNameContainer = document.getElementById('sheet-name-container');
      const thead = document.getElementById('tableHead');
      const tbody = document.getElementById('tableBody');
      const selectSaleStatus = document.getElementById("status-container");
      const quantityContainer = document.getElementById('quantity-container');
      const statusLog = document.getElementById("statusLog");
      const loadingState = document.getElementById("loading-status");

      window.onload = function() {
        fetchProductHeaders();
        fetchProducts();
      };

      function fetchProductHeaders() {
        google.script.run
          .withSuccessHandler(handleFetchHeadersSuccess)
          .getProductHeaders();
      }
      function fetchProducts() {
        google.script.run
          .withSuccessHandler(handleFetchProductsSuccess)
          .getProductsList();
      }

      function handleFetchProductsSuccess(data) {
        renderProducts(data)
      }

      function handleFetchHeadersSuccess(headers){
        renderHeaders(headers);
      }


      function renderHeaders(headers) {
        thead.innerHTML = '';
        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          thead.appendChild(th);
        });
      }

      function renderProducts(allProducts) {

        if(allProducts.length === 0) {
            loadingState.innerHTML = '<span>No results found</span>';
            return;
        }

        allProducts.forEach(row => {
          const tr = document.createElement('tr');
          row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        loadingState.innerHTML = '';
      }

      function toggleForm() {
        form.style.display = (form.style.display === 'none') ? 'block' : 'none';
      }

      /* Pull all data to be sent to sheet by calling functions or DOM values */
      function addSheetData() {
          const submissionId = "saleId_" + Date.now();
          var sheetNameSelected = getSelectedSheetName();
          var saleStatus = getSelectedSaleStatus();
          var quantity = quantityContainer.value;
          var productNameValue = "placeholder name";
          var productCategory = "placeholder category";
          var productPrice = 10;

          /* Save form values on a single object */
          const formData ={sheet: sheetNameSelected, name:productNameValue, category: productCategory, quantity: quantity, status:saleStatus, price:productPrice, saleId:submissionId};

          failedSubmissions[submissionId] = formData;

          if(sheetNameSelected !="" && productNameValue !="" && saleStatus!="" && quantity>0){
              saveButton.disabled = true;
              addLogEntry(submissionId, `Sending ${submissionId} to spreadsheet...`);

              google.script.run.withSuccessHandler(handleSuccess(submissionId)).withFailureHandler(handleError(submissionId)).sendSaleToSheet(formData);
              form.reset();

          } else {
            alert("Please select all required fields");
            saveButton.disabled = false;
          }
          saveButton.disabled = false;
      }

      function getSelectedSheetName(){
        return selectSheetNameContainer.options[selectSheetNameContainer.selectedIndex].value;
      }

      function validateSheetName(sheetNames) {
          const sheetNameSelected = getSelectedSheetName();
          const isNameOnSpreadsheet = sheetNames.find((sheet) => sheetNameSelected === sheet)
          if(isNameOnSpreadsheet == undefined || isNameOnSpreadsheet == null || sheetNameSelected == ""){
            alert("User name not found on Spreadsheet!")
            selectSheetNameContainer.selectedIndex = -1;
          }
      }

      function addLogEntry(submissionId, message) {
        const logEntry = document.createElement("p");
        logEntry.id = submissionId;
        logEntry.innerHTML = message;
        statusLog.prepend(logEntry);
      }

      function handleSuccess(submissionId) {
            return function(){
            const entry = document.getElementById(submissionId);
            entry.style.color = "green";
            entry.innerHTML = `Success: ${submissionId} sent to spreadsheet successfully`;
            delete failedSubmissions[submissionId];
          }
      }

      function handleError(submissionId) {
        return function (error) {
          const entry = document.getElementById(submissionId);
          entry.style.color = "red";
          entry.innerHTML = `Unable to send ${submissionId} to Spreadsheet. Please check your internet connection or that you are signed in to your Google account - Error Code: ${error}  <button onclick="retrySubmission('${submissionId}')">Retry</button>`;
        }
      }

      function retrySubmission(submissionId) {
        const formData = failedSubmissions[submissionId];
        const entry = document.getElementById(submissionId);

        entry.style.color = "black";
        entry.innerHTML = `Re-sending ${submissionId} to spreadsheet...`;

        google.script.run.withSuccessHandler(handleSuccess(submissionId)).withFailureHandler(handleError(submissionId)).sendSaleToSheet(formData);
      }

      function getAllSheetsNames () {
        google.script.run.withSuccessHandler(validateSheetName).getSheetsNames();
      }


      function getSelectedSaleStatus (){
        return selectSaleStatus.options[selectSaleStatus.selectedIndex].value;
      }


/* DOM elements event listeners needed for program logic */
      window.addEventListener('beforeunload', function (e) { e.preventDefault(); e.returnValue='';});
      saveButton.addEventListener("click", addSheetData);
      selectSheetNameContainer.addEventListener('change', getAllSheetsNames);
    </script>
  </body>
</html>
